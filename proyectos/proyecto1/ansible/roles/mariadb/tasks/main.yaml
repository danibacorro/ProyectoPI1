- name: Instalar MariaDB
  apt:
    pkg:
      - mariadb-server
      - python3-mysqldb
    state: latest
    update_cache: yes

- name: Crear base de datos Guestbook
  community.mysql.mysql_db:
    name: "{{ guestbook_db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Crear usuario y otorgar privilegios para Guestbook
  community.mysql.mysql_user:
    name: "{{ guestbook_db_user }}"
    password: "{{ guestbook_db_password }}"
    host: "%"
    priv: "{{ guestbook_db_name }}.*:ALL"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Crear usuario administrador para phpMyAdmin
  community.mysql.mysql_user:
    name: admin
    password: "admin"
    host: "%"
    priv: "*.*:ALL"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Copiar esquema SQL de Guestbook al servidor MariaDB
  ansible.builtin.copy:
    src: schema.sql
    dest: /tmp/schema.sql

- name: Comprobar si la tabla 'messages' de Guestbook existe
  community.mysql.mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    query: "SHOW TABLES FROM {{ guestbook_db_name }} LIKE 'messages';"
  register: table_check

- name: Importar esquema SQL de Guestbook (solo si la tabla no existe)
  community.mysql.mysql_db:
    name: "{{ guestbook_db_name }}"
    state: import
    target: /tmp/schema.sql
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: table_check.query_result[0] | length == 0


- name: Configurar MariaDB para escuchar en todas las interfaces
  ansible.builtin.lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '^bind-address'
    line: 'bind-address = 0.0.0.0'
    state: present
  notify: restart mariadb